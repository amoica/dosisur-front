<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
<p-card class="page-card">
  <div class="p-grid">
    <!-- Título y descripción -->
    <div class="p-col-12">
      <h1 class="page-title">Gestión de Roles y Permisos</h1>
      <p class="page-description">
        Administra roles, busca, crea, edita o elimina. Asigna permisos fácilmente.
      </p>
    </div>

    <!-- Toolbar -->
    <div class="p-col-12 toolbar">
      <div class="search-wrapper">
        <input
          #search
          type="text"
          pInputText
          placeholder="Buscar roles"
          class="search-input"
          (input)="dt.filterGlobal(search.value, 'contains')"
        />
        <button pButton icon="pi pi-search" class="p-button-outlined"></button>
      </div>
      <button
        pButton
        label="Nuevo Rol"
        icon="pi pi-plus"
        class="p-button-primary"
        (click)="openNew()"
      ></button>
    </div>
  </div>

  <!-- Tabla -->
  <p-table
    #dt
    [value]="roles"
    [paginator]="true"
    [rows]="10"
    [globalFilterFields]="['name','description']"
    [rowsPerPageOptions]="[5,10,20]"
    responsiveLayout="scroll"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} roles"
    class="minimal-table"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="name">Nombre <p-sortIcon field="name"></p-sortIcon></th>
        <th pSortableColumn="description">
          Descripción <p-sortIcon field="description"></p-sortIcon>
        </th>
        <th class="text-center">Sistema</th>
        <th class="text-center">Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-r>
      <tr>
        <td>{{ r.name }}</td>
        <td>{{ r.description }}</td>
        <td class="text-center">
          <p-checkbox [binary]="true" [disabled]="true" [ngModel]="r.isSystem"></p-checkbox>
        </td>
        <td class="text-center">
          <button
            pButton
            icon="pi pi-eye"
            class="p-button-text p-button-info p-mr-2"
            (click)="viewPermissions(r)"
          ></button>
          <button
            pButton
            icon="pi pi-pencil"
            class="p-button-text p-button-warning"
            (click)="openEdit(r)"
          ></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<!-- Diálogo Crear/Editar -->
<p-dialog
  [(visible)]="editDialog"
  modal="true"
  [styleClass]="'custom-dialog role-dialog'"
  (onHide)="closeEdit()"
  [closable]="false"
>
  <div class="decorative-section">
    <i class="pi pi-user-shield"></i>
    <h2>{{ editing ? 'Editar Rol' : 'Nuevo Rol' }}</h2>
  </div>

  <form [formGroup]="form" class="form-grid">
    <!-- Nombre -->
    <div class="p-field">
      <label for="name">Nombre <span class="required">*</span></label>
      <input id="name" pInputText formControlName="name" />
    </div>

    <!-- Descripción -->
    <div class="p-field full-width">
      <label for="description">Descripción</label>
      <textarea
        id="description"
        rows="3"
        pInputTextarea
        formControlName="description"
      ></textarea>
    </div>

    <!-- Rol de sistema en la misma fila -->
    <div class="p-field checkbox-field full-width">
      <p-checkbox inputId="isSystem" binary="true" formControlName="isSystem"></p-checkbox>
      <label for="isSystem" class="p-ml-2">Rol de sistema</label>
    </div>

    <!-- Permisos -->
    <div class="p-field full-width">
      <label>Permisos</label>
      <p-pickList
        [source]="availablePerms"
        [target]="selectedPerms"
        sourceHeader="Disponibles"
        targetHeader="Asignados"
        dragdrop="true"
        filter="true"
        [style]="{ width: '100%', height: '250px' }"
        (onTransfer)="onPermsTransfer($event)"
      >
        <ng-template let-p pTemplate="item">
          <div class="pick-item">{{ p.category }} → {{ p.name }}</div>
        </ng-template>
      </p-pickList>
    </div>

    <!-- Footer con botones -->
    <p-footer class="modal-footer">
      <button
        pButton
        label="Cancelar"
        icon="pi pi-times"
        class="p-button-text"
        (click)="closeEdit()"
      ></button>
      <button
        pButton
        label="Guardar"
        icon="pi pi-check"
        [disabled]="form.invalid"
        (click)="save()"
      ></button>
    </p-footer>
  </form>
</p-dialog>

<!-- Diálogo Ver Permisos -->
<p-dialog
  header="Permisos de {{ viewRole?.name }}"
  [(visible)]="viewDialog"
  modal="true"
  [styleClass]="'custom-dialog view-dialog'"
  (onHide)="closeView()"
  [closable]="true"
>
  <ul class="permissions-list">
    <li *ngFor="let p of viewPermissionsList">
      <i class="pi pi-check-circle text-success p-mr-2"></i>
      {{ p.category }} → {{ p.name }}
    </li>
  </ul>
  <p-footer>
    <button pButton label="Cerrar" icon="pi pi-times" (click)="closeView()"></button>
  </p-footer>
</p-dialog>